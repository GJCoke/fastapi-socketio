<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>FastAPI-SIO æµ‹è¯•å®¢æˆ·ç«¯</title>
    <!-- å¼•å…¥ Socket.IO å®¢æˆ·ç«¯ SDK (CDN) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        #log { background: #f4f4f4; border: 1px solid #ccc; padding: 10px; height: 300_px; overflow-y: auto; }
        .status { font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>FastAPI-SIO è°ƒè¯•é¢æ¿</h1>
    <div>
        çŠ¶æ€: <span id="status" class="status">æœªè¿æ¥</span>
    </div>
    <br>
    <button onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
    <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
    
    <h3>æ—¥å¿—:</h3>
    <div id="log"></div>

    <script>
        let socket;
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');

        function addLog(msg, isError = false) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()} - ${msg}`;
            if (isError) div.className = 'error';
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function connect() {
            // æ³¨æ„ï¼šå¦‚æœä½ åœ¨ server.py ä¸­ app.mount("/", sio_app)
            // é‚£ä¹ˆè¿™é‡Œçš„è·¯å¾„é»˜è®¤å°±æ˜¯ /socket.io/
            socket = io("http://127.0.0.1:8004", {
                // æ¨¡æ‹Ÿ auth å­—æ®µï¼ˆå¯¹åº”æœåŠ¡å™¨ connect äº‹ä»¶çš„ auth å‚æ•°ï¼‰
                auth: {
                    token: "my-secret-token"
                },
                // å¦‚æœä½ æƒ³æµ‹è¯• Header ä¾èµ–ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–é…ç½®
                // æ³¨æ„ï¼šæµè§ˆå™¨ç«¯æ— æ³•åœ¨ WebSocket æ¡æ‰‹é˜¶æ®µè‡ªå®šä¹‰ Headerï¼Œ
                // ä½†å¯ä»¥åœ¨ HTTP Polling é˜¶æ®µå‘é€ã€‚
                extraHeaders: {
                    "Authorization": "Bearer browser-token"
                }
            });

            socket.on("connect", () => {
                statusElement.textContent = "å·²è¿æ¥ (ID: " + socket.id + ")";
                statusElement.className = "status success";
                addLog("âœ… è¿æ¥æˆåŠŸ");
            });

            socket.on("connect_error", (err) => {
                statusElement.textContent = "è¿æ¥å¤±è´¥";
                statusElement.className = "status error";
                addLog("âŒ è¿æ¥é”™è¯¯: " + err.message, true);
                console.error("Connect Error Detail:", err);
            });

            socket.on("disconnect", () => {
                statusElement.textContent = "å·²æ–­å¼€";
                statusElement.className = "status";
                addLog("âš ï¸ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥");
            });

            socket.on("reply", (data) => {
                addLog("ğŸ“© æ”¶åˆ°å›å¤: " + JSON.stringify(data));
            });
        }

        function sendMessage() {
            if (!socket || !socket.connected) {
                alert("è¯·å…ˆè¿æ¥æœåŠ¡å™¨ï¼");
                return;
            }
            const data = { msg: "æ¥è‡ªæµè§ˆå™¨çš„ Hello!" };
            addLog("ğŸ“¤ å‘é€: " + JSON.stringify(data));
            socket.emit("message", data);
        }

        function disconnect() {
            if (socket) socket.disconnect();
        }
    </script>
</body>
</html>
